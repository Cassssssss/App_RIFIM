{"ast":null,"code":"// src/pages/AddContent.js\nimport React,{useState,useEffect,useRef}from'react';import{useNavigate,useParams,useLocation}from'react-router-dom';import{ChevronLeft}from'lucide-react';import ReactQuill from'react-quill';import{api}from'../services/api';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export const AddContent=()=>{const{systemId,locationId,type}=useParams();const navigate=useNavigate();const location=useLocation();const quillRef=useRef(null);const fileInputRef=useRef(null);const[formData,setFormData]=useState({title:'',description:'',images:[]});const[loading,setLoading]=useState(false);const[error,setError]=useState(null);const[previewUrls,setPreviewUrls]=useState([]);useEffect(()=>{console.log('Current URL:',window.location.href);console.log('Location state:',location);console.log('URL Params:',{systemId,locationId,type});if(!systemId||!locationId||locationId==='undefined'||!type){console.error('Paramètres invalides:',{systemId,locationId,type});setError('Paramètres invalides');setTimeout(()=>{navigate('/');},2000);return;}},[systemId,locationId,type,navigate,location]);useEffect(()=>{return()=>{// Cleanup preview URLs on unmount\npreviewUrls.forEach(url=>URL.revokeObjectURL(url));};},[previewUrls]);const handleSubmit=async e=>{e.preventDefault();if(!locationId||locationId==='undefined'){console.error('ID de localisation invalide:',locationId);setError('ID de localisation invalide');return;}if(!systemId){console.error('ID du système invalide:',systemId);setError('ID du système invalide');return;}if(!formData.title.trim()){setError('Le titre est requis');return;}setLoading(true);setError(null);try{const formDataToSend=new FormData();formDataToSend.append('title',formData.title.trim());formDataToSend.append('description',formData.description);formDataToSend.append('type',type);formDataToSend.append('locationId',locationId);if(formData.images&&formData.images.length>0){Array.from(formData.images).forEach(file=>{formDataToSend.append('images',file);});}console.log('Sending FormData with:',{locationId,type,title:formData.title});const result=await api.createContent(locationId,formDataToSend);console.log('Content created:',result);navigate(`/system/${systemId}/location/${locationId}`);}catch(error){console.error('Erreur détaillée:',error);setError(error.message||'Erreur lors de la création de la fiche');}finally{setLoading(false);}};const handleImageChange=e=>{const files=e.target.files;if(files&&files.length>0){// Validate each file\nconst validFiles=Array.from(files).filter(file=>{const isValid=file.type.startsWith('image/');if(!isValid){setError(`Le fichier ${file.name} n'est pas une image valide`);}return isValid;});if(validFiles.length>0){setFormData(prev=>({...prev,images:validFiles}));// Create and store preview URLs\nconst urls=validFiles.map(file=>URL.createObjectURL(file));setPreviewUrls(prev=>{prev.forEach(url=>URL.revokeObjectURL(url));return urls;});}}};const handleCancel=()=>{// Clean up preview URLs\npreviewUrls.forEach(url=>URL.revokeObjectURL(url));navigate(`/system/${systemId}/location/${locationId}`);};const quillModules={toolbar:{container:[[{'header':[1,2,false]}],['bold','italic','underline','strike'],[{'list':'ordered'},{'list':'bullet'}],['link','clean'],['clean']]},clipboard:{matchVisual:false}};if(error&&(!systemId||!locationId)){return/*#__PURE__*/_jsx(\"div\",{className:\"min-h-screen bg-gray-50 flex items-center justify-center p-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm sm:text-base\",children:[error,/*#__PURE__*/_jsx(\"p\",{className:\"mt-2\",children:\"Redirection en cours...\"})]})});}return/*#__PURE__*/_jsxs(\"div\",{className:\"min-h-screen bg-gray-50\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"bg-[#4f5b93] text-white p-4 flex items-center sticky top-0 z-50\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:handleCancel,className:\"mr-4\",children:/*#__PURE__*/_jsx(ChevronLeft,{size:24})}),/*#__PURE__*/_jsxs(\"h1\",{className:\"text-lg sm:text-xl font-semibold truncate\",children:[\"Ajouter une fiche \",type==='measure'?'de repères & mesures':'de classification']})]}),/*#__PURE__*/_jsx(\"div\",{className:\"p-2 sm:p-4 pb-24\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"max-w-4xl mx-auto\",children:[error&&/*#__PURE__*/_jsx(\"div\",{className:\"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm sm:text-base\",children:error}),/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleSubmit,className:\"space-y-4 sm:space-y-6\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{className:\"block text-gray-700 font-medium mb-1 sm:mb-2\",children:\"Titre\"}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:formData.title,onChange:e=>setFormData(prev=>({...prev,title:e.target.value})),className:\"w-full p-2 sm:p-3 border rounded-lg focus:ring-2 focus:ring-[#4f5b93] focus:border-transparent\",placeholder:\"Entrez le titre de la fiche\",required:true})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{className:\"block text-gray-700 font-medium mb-1 sm:mb-2\",children:\"Description\"}),/*#__PURE__*/_jsx(\"div\",{className:\"bg-white rounded-lg border\",children:/*#__PURE__*/_jsx(ReactQuill,{ref:quillRef,value:formData.description,onChange:content=>setFormData(prev=>({...prev,description:content})),modules:quillModules,theme:\"snow\",className:\"h-48 sm:h-64 mb-12\",placeholder:\"Entrez la description d\\xE9taill\\xE9e...\"})})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{className:\"block text-gray-700 font-medium mb-1 sm:mb-2\",children:\"Images\"}),/*#__PURE__*/_jsx(\"input\",{ref:fileInputRef,type:\"file\",multiple:true,accept:\"image/*\",onChange:handleImageChange,className:\"w-full p-2 border rounded-lg text-sm sm:text-base\"}),previewUrls.length>0&&/*#__PURE__*/_jsx(\"div\",{className:\"grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-4 mt-4\",children:previewUrls.map((url,index)=>/*#__PURE__*/_jsx(\"div\",{className:\"relative aspect-video\",children:/*#__PURE__*/_jsx(\"img\",{src:url,alt:`Aperçu ${index+1}`,className:\"w-full h-full object-cover rounded-lg\"})},index))})]}),/*#__PURE__*/_jsx(\"div\",{className:\"fixed bottom-0 left-0 right-0 bg-white border-t p-2 sm:p-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"max-w-4xl mx-auto flex gap-2 sm:gap-4\",children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:handleCancel,className:\"flex-1 bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 transition-colors text-sm sm:text-base\",children:\"Annuler\"}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",disabled:loading,className:`flex-1 bg-[#4f5b93] text-white p-3 rounded-lg hover:bg-[#3f4973] transition-colors text-sm sm:text-base\n                    ${loading?'opacity-50 cursor-not-allowed':''}`,children:loading?'Création en cours...':'Créer'})]})})]})]})})]});};export default AddContent;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}